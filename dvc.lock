schema: '2.0'
stages:
  prepare:
    cmd: gunzip -k data/gwas/homo_sapiens_ensembl_103/Homo_sapiens.GRCh38.dna.primary_assembly.fa.gz
      && unzip -o -d data/ensembl/103 data/ensembl/103/103.zip && mv data/ensembl/103/VEP_plugins-release-103
      data/ensembl/103/plugins
    deps:
    - path: data/ensembl/103/103.zip
    - path: data/gwas/homo_sapiens_ensembl_103/Homo_sapiens.GRCh38.dna.primary_assembly.fa.gz
    outs:
    - path: data/ensembl/103/plugins
    - path: data/gwas/homo_sapiens_ensembl_103/Homo_sapiens.GRCh38.dna.primary_assembly.fa
  start:
    cmd: docker-compose up
  stop:
    cmd: docker-compose down
  cache:
    cmd: tar -C  data/ensembl/103/cache/ -zxvf data/ensembl/103/cache/homo_sapiens_vep_103_GRCh38.tar.gz
    deps:
    - path: data/ensembl/103/cache/homo_sapiens_vep_103_GRCh38.tar.gz
    outs:
    - path: data/ensembl/103/cache/homo_sapiens
  prepare_genome:
    cmd: gunzip -k data/ensembl/103/species/homo_sapiens/Homo_sapiens.GRCh38.dna.primary_assembly.fa.gz
      && samtools faidx data/ensembl/103/species/homo_sapiens/Homo_sapiens.GRCh38.dna.primary_assembly.fa
      && samtools dict data/ensembl/103/species/homo_sapiens/Homo_sapiens.GRCh38.dna.primary_assembly.fa
      -o data/ensembl/103/species/homo_sapiens/Homo_sapiens.GRCh38.dna.primary_assembly.fa.dict
    deps:
    - path: data/ensembl/103/species/homo_sapiens/Homo_sapiens.GRCh38.dna.primary_assembly.fa.gz
      md5: f58a039f83d8944ceb79cdd16cbda583
      size: 881211416
    outs:
    - path: data/ensembl/103/species/homo_sapiens/Homo_sapiens.GRCh38.dna.primary_assembly.fa
      md5: 9e6b9465dc708d92bf6d67e9c9fa9389
      size: 3151425857
    - path: data/ensembl/103/species/homo_sapiens/Homo_sapiens.GRCh38.dna.primary_assembly.fa.dict
      md5: 74f301cbacef639028b77320918bc8ab
      size: 34186
    - path: data/ensembl/103/species/homo_sapiens/Homo_sapiens.GRCh38.dna.primary_assembly.fa.fai
      md5: d527f3eb6b664020cf4d882b5820056f
      size: 6406
  prepare_vep:
    cmd: unzip -u data/ensembl/103/103.zip -d data/ensembl/103/ && mv data/ensembl/103/VEP_plugins-release-103
      data/ensembl/103/plugins
    deps:
    - path: data/ensembl/103/103.zip
    - path: data/ensembl/103/cache/homo_sapiens_vep_103_GRCh38.tar.gz
    outs:
    - path: data/ensembl/103/plugins/
  prepare_annotations:
    cmd: "gunzip -c data/gwas/annotations/all_variant_disease_pmid_associations.tsv.gz\
      \ |\n   awk '($1 ~ /^snpId/ || $2 ~ /NA/) {next} {print $0}' |\n   sort -t $'\\\
      t' -k2,2 -k3,3n |\n   awk '{ gsub (/\\t +/, \"\\t\", $0); print}' |\n   bgzip\
      \ -c > data/gwas/annotations/all_variant_disease_pmid_associations_final.tsv.gz\
      \ &&\nrm -f data/gwas/annotations/gene2phenotype/AllG2P.csv && awk '(NR == 1)\
      \ || (FNR > 1)' data/gwas/annotations/gene2phenotype/*.csv  > data/gwas/annotations/gene2phenotype/AllG2P.csv"
    deps:
    - path: data/gwas/annotations/all_variant_disease_pmid_associations.tsv.gz
    - path: data/gwas/annotations/clinvar.vcf.gz
    - path: data/gwas/annotations/clinvar.vcf.gz.tbi
    - path: data/gwas/annotations/gene2phenotype/CancerG2P.csv
    - path: data/gwas/annotations/gene2phenotype/DDG2P.csv
    - path: data/gwas/annotations/gene2phenotype/EyeG2P.csv
    - path: data/gwas/annotations/gene2phenotype/SkinG2P.csv
    outs:
    - path: data/gwas/annotations/all_variant_disease_pmid_associations_final.tsv.gz
    - path: data/gwas/annotations/gene2phenotype/AllG2P.csv
  prepare_vep_plugins:
    cmd: unzip -u data/ensembl/103/103.zip -d data/ensembl/103/ && mv data/ensembl/103/VEP_plugins-release-103
      data/ensembl/103/plugins
    deps:
    - path: data/ensembl/103/103.zip
    outs:
    - path: data/ensembl/103/plugins/
  prepare_vep_cache:
    cmd: tar -zxf data/ensembl/103/cache/homo_sapiens_vep_103_GRCh38.tar.gz -C data/ensembl/103/cache/
    deps:
    - path: data/ensembl/103/cache/homo_sapiens_vep_103_GRCh38.tar.gz
    outs:
    - path: data/ensembl/103/cache/homo_sapiens
  prepare_annotations_clinvar:
    cmd: echo "Clinvars annotations prepared"
    deps:
    - path: data/gwas/annotations/clinvar.vcf.gz
    - path: data/gwas/annotations/clinvar.vcf.gz.tbi
  prepare_annotations_gene2phenotype:
    cmd: rm -f data/gwas/annotations/gene2phenotype/AllG2P.csv && awk '(NR == 1) ||
      (FNR > 1)' data/gwas/annotations/gene2phenotype/*.csv  > data/gwas/annotations/gene2phenotype/AllG2P.csv
    deps:
    - path: data/gwas/annotations/gene2phenotype/CancerG2P.csv
    - path: data/gwas/annotations/gene2phenotype/DDG2P.csv
    - path: data/gwas/annotations/gene2phenotype/EyeG2P.csv
    - path: data/gwas/annotations/gene2phenotype/SkinG2P.csv
    outs:
    - path: data/gwas/annotations/gene2phenotype/AllG2P.csv
  prepare_annotations_digenet:
    cmd: "gunzip -c data/gwas/annotations/all_variant_disease_pmid_associations.tsv.gz\
      \ |\n   awk '($1 ~ /^snpId/ || $2 ~ /NA/) {next} {print $0}' |\n   sort -t $'\\\
      t' -k2,2 -k3,3n |\n   awk '{ gsub (/\\t +/, \"\\t\", $0); print}' |\n   bgzip\
      \ -c > data/gwas/annotations/all_variant_disease_pmid_associations_final.tsv.gz"
    deps:
    - path: data/gwas/annotations/all_variant_disease_pmid_associations.tsv.gz
    outs:
    - path: data/gwas/annotations/all_variant_disease_pmid_associations_final.tsv.gz
  prepare_opencravat:
    cmd: oc module install-base
  test_opencravat:
    cmd: oc new example-input . && oc run ./example_input -l hg38 && oc gui example_input/example_input.sqlite
